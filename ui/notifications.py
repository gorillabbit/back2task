import platform
import time
from typing import Optional, Dict, Any, Callable
from dataclasses import dataclass
from enum import Enum


class NotificationLevel(Enum):
    """ÈÄöÁü•„É¨„Éô„É´"""
    INFO = "info"
    WARNING = "warning" 
    URGENT = "urgent"


@dataclass
class NotificationConfig:
    """ÈÄöÁü•Ë®≠ÂÆö"""
    enable_toast: bool = True
    enable_sound: bool = True
    enable_flash: bool = False
    toast_duration: int = 5  # Áßí
    flash_duration: float = 0.5  # Áßí
    flash_count: int = 3


class NotificationService:
    """„Éû„É´„ÉÅ„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†ÈÄöÁü•„Çµ„Éº„Éì„Çπ"""
    
    def __init__(self, config: Optional[NotificationConfig] = None):
        """
        Args:
            config: ÈÄöÁü•Ë®≠ÂÆö
        """
        self.config = config or NotificationConfig()
        self.platform = platform.system()
        
        # „Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†Âõ∫Êúâ„ÅÆÂàùÊúüÂåñ
        self._init_platform_specific()
        
        # ÈÄöÁü•Â±•Ê≠¥
        self.notification_history = []
        self.max_history = 100
        
        # „É¨„Éº„ÉàÂà∂Èôê
        self.last_notification_time = 0
        self.min_notification_interval = 1.0  # Áßí
        
    def _init_platform_specific(self):
        """„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†Âõ∫Êúâ„ÅÆÂàùÊúüÂåñ"""
        self.toast_available = False
        self.sound_available = False
        self.flash_available = False
        
        if self.platform == "Windows":
            self._init_windows()
        elif self.platform == "Linux":
            self._init_linux()
        elif self.platform == "Darwin":  # macOS
            self._init_macos()
    
    def _init_windows(self):
        """WindowsÂõ∫Êúâ„ÅÆÂàùÊúüÂåñ"""
        try:
            # WinRT for Toast notifications
            from winrt.windows.ui.notifications import ToastNotificationManager
            from winrt.windows.data.xml.dom import XmlDocument
            self.toast_available = True
            self._ToastNotificationManager = ToastNotificationManager
            self._XmlDocument = XmlDocument
        except ImportError:
            print("Windows toast notifications not available")
        
        try:
            # Windows API for sound and flash
            import winsound
            self.sound_available = True
            self._winsound = winsound
        except ImportError:
            print("Windows sound not available")
        
        # Flash (ÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•) „ÅØ Windows API „ÅßÂÆüË£ÖÂèØËÉΩ
        self.flash_available = True
    
    def _init_linux(self):
        """LinuxÂõ∫Êúâ„ÅÆÂàùÊúüÂåñ"""
        try:
            # notify-send for desktop notifications
            import subprocess
            result = subprocess.run(["which", "notify-send"], 
                                   capture_output=True, text=True)
            if result.returncode == 0:
                self.toast_available = True
        except Exception:
            pass
        
        try:
            # Play sound using paplay/aplay
            import subprocess
            for cmd in ["paplay", "aplay", "play"]:
                result = subprocess.run(["which", cmd], 
                                       capture_output=True, text=True)
                if result.returncode == 0:
                    self.sound_available = True
                    self._sound_cmd = cmd
                    break
        except Exception:
            pass
        
        # Flash can be implemented via X11
        try:
            import subprocess
            result = subprocess.run(["which", "xset"], 
                                   capture_output=True, text=True)
            if result.returncode == 0:
                self.flash_available = True
        except Exception:
            pass
    
    def _init_macos(self):
        """macOSÂõ∫Êúâ„ÅÆÂàùÊúüÂåñ"""
        try:
            # osascript for notifications
            import subprocess
            result = subprocess.run(["which", "osascript"], 
                                   capture_output=True, text=True)
            if result.returncode == 0:
                self.toast_available = True
        except Exception:
            pass
        
        try:
            # afplay for sound
            import subprocess
            result = subprocess.run(["which", "afplay"], 
                                   capture_output=True, text=True)
            if result.returncode == 0:
                self.sound_available = True
        except Exception:
            pass
    
    def _rate_limit_check(self) -> bool:
        """„É¨„Éº„ÉàÂà∂Èôê„ÉÅ„Çß„ÉÉ„ÇØ"""
        now = time.time()
        if now - self.last_notification_time < self.min_notification_interval:
            return False
        self.last_notification_time = now
        return True
    
    def notify(self, 
               title: str, 
               message: str, 
               level: NotificationLevel = NotificationLevel.INFO,
               sound: Optional[bool] = None,
               flash: Optional[bool] = None) -> bool:
        """
        ÈÄöÁü•„ÇíÈÄÅ‰ø°
        
        Args:
            title: ÈÄöÁü•„Çø„Ç§„Éà„É´
            message: ÈÄöÁü•„É°„ÉÉ„Çª„Éº„Ç∏
            level: ÈÄöÁü•„É¨„Éô„É´
            sound: Èü≥„ÇíÈ≥¥„Çâ„Åô„ÅãÔºàNone„ÅÆÂ†¥Âêà„ÅØË®≠ÂÆö„Å´Âæì„ÅÜÔºâ
            flash: ÁîªÈù¢„Çí„Éï„É©„ÉÉ„Ç∑„É•„Åô„Çã„ÅãÔºàNone„ÅÆÂ†¥Âêà„ÅØË®≠ÂÆö„Å´Âæì„ÅÜÔºâ
            
        Returns:
            bool: ÈÄöÁü•ÈÄÅ‰ø°ÊàêÂäüÊôÇTrue
        """
        # „É¨„Éº„ÉàÂà∂Èôê„ÉÅ„Çß„ÉÉ„ÇØ
        if not self._rate_limit_check():
            return False
        
        # Ë®≠ÂÆö„ÅÆ„Ç™„Éº„Éê„Éº„É©„Ç§„Éâ
        play_sound = sound if sound is not None else self.config.enable_sound
        do_flash = flash if flash is not None else self.config.enable_flash
        
        # ÈÄöÁü•Â±•Ê≠¥„Å´Ë®òÈå≤
        notification_record = {
            "timestamp": time.time(),
            "title": title,
            "message": message,
            "level": level.value,
            "sound": play_sound,
            "flash": do_flash
        }
        self.notification_history.append(notification_record)
        
        # Â±•Ê≠¥„Çµ„Ç§„Ç∫Âà∂Èôê
        if len(self.notification_history) > self.max_history:
            self.notification_history.pop(0)
        
        success = True
        
        # ToastÈÄöÁü•
        if self.config.enable_toast:
            success &= self._send_toast(title, message, level)
        
        # Èü≥ÈÄöÁü•
        if play_sound and level != NotificationLevel.INFO:
            self._play_sound(level)
        
        # „Éï„É©„ÉÉ„Ç∑„É•ÈÄöÁü•
        if do_flash and level == NotificationLevel.URGENT:
            self._flash_screen()
        
        return success
    
    def _send_toast(self, title: str, message: str, level: NotificationLevel) -> bool:
        """ToastÈÄöÁü•„ÇíÈÄÅ‰ø°"""
        if not self.toast_available:
            print(f"[{level.value.upper()}] {title}: {message}")
            return True
        
        try:
            if self.platform == "Windows":
                return self._send_windows_toast(title, message, level)
            elif self.platform == "Linux":
                return self._send_linux_notification(title, message, level)
            elif self.platform == "Darwin":
                return self._send_macos_notification(title, message, level)
        except Exception as e:
            print(f"Toast notification error: {e}")
            # „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Ç≥„É≥„ÇΩ„Éº„É´Âá∫Âäõ
            print(f"[{level.value.upper()}] {title}: {message}")
            return False
        
        return False
    
    def _send_windows_toast(self, title: str, message: str, level: NotificationLevel) -> bool:
        """Windows ToastÈÄöÁü•"""
        try:
            # „É¨„Éô„É´„Å´Âøú„Åò„Åü„Ç¢„Ç§„Ç≥„É≥Ë®≠ÂÆö
            icon_type = {
                NotificationLevel.INFO: "",
                NotificationLevel.WARNING: "‚ö†Ô∏è",
                NotificationLevel.URGENT: "üö®"
            }.get(level, "")
            
            display_title = f"{icon_type} {title}".strip()
            
            xml_template = f"""
            <toast>
                <visual>
                    <binding template='ToastGeneric'>
                        <text>{display_title}</text>
                        <text>{message}</text>
                    </binding>
                </visual>
                <audio src='ms-winsoundevent:Notification.Default' />
            </toast>
            """
            
            doc = self._XmlDocument()
            doc.load_xml(xml_template)
            
            notifier = self._ToastNotificationManager.create_toast_notifier("Back2Task")
            toast = self._ToastNotificationManager.ToastNotification(doc)
            
            notifier.show(toast)
            return True
            
        except Exception as e:
            print(f"Windows toast error: {e}")
            return False
    
    def _send_linux_notification(self, title: str, message: str, level: NotificationLevel) -> bool:
        """Linux desktop notification"""
        try:
            import subprocess
            
            # „É¨„Éô„É´„Å´Âøú„Åò„ÅüË®≠ÂÆö
            urgency_map = {
                NotificationLevel.INFO: "low",
                NotificationLevel.WARNING: "normal", 
                NotificationLevel.URGENT: "critical"
            }
            
            icon_map = {
                NotificationLevel.INFO: "dialog-information",
                NotificationLevel.WARNING: "dialog-warning",
                NotificationLevel.URGENT: "dialog-error"
            }
            
            cmd = [
                "notify-send",
                "--urgency", urgency_map[level],
                "--icon", icon_map[level],
                "--expire-time", str(self.config.toast_duration * 1000),
                title,
                message
            ]
            
            result = subprocess.run(cmd, capture_output=True, text=True, timeout=5)
            return result.returncode == 0
            
        except Exception as e:
            print(f"Linux notification error: {e}")
            return False
    
    def _send_macos_notification(self, title: str, message: str, level: NotificationLevel) -> bool:
        """macOS notification"""
        try:
            import subprocess
            
            script = f'''
            display notification "{message}" with title "{title}"
            '''
            
            result = subprocess.run(
                ["osascript", "-e", script],
                capture_output=True, text=True, timeout=5
            )
            return result.returncode == 0
            
        except Exception as e:
            print(f"macOS notification error: {e}")
            return False
    
    def _play_sound(self, level: NotificationLevel):
        """Èü≥„ÇíÂÜçÁîü"""
        if not self.sound_available:
            return
        
        try:
            if self.platform == "Windows":
                self._play_windows_sound(level)
            elif self.platform == "Linux":
                self._play_linux_sound(level)
            elif self.platform == "Darwin":
                self._play_macos_sound(level)
        except Exception as e:
            print(f"Sound play error: {e}")
    
    def _play_windows_sound(self, level: NotificationLevel):
        """WindowsÈü≥ÂÜçÁîü"""
        sound_map = {
            NotificationLevel.INFO: self._winsound.MB_OK,
            NotificationLevel.WARNING: self._winsound.MB_ICONEXCLAMATION,
            NotificationLevel.URGENT: self._winsound.MB_ICONHAND
        }
        
        self._winsound.MessageBeep(sound_map[level])
    
    def _play_linux_sound(self, level: NotificationLevel):
        """LinuxÈü≥ÂÜçÁîü"""
        # „Ç∑„Çπ„ÉÜ„É†Èü≥„ÇíÂÜçÁîüÔºà/usr/share/sounds/„Åã„ÇâÔºâ
        import subprocess
        
        sound_files = {
            NotificationLevel.INFO: "/usr/share/sounds/alsa/Front_Left.wav",
            NotificationLevel.WARNING: "/usr/share/sounds/alsa/Side_Left.wav", 
            NotificationLevel.URGENT: "/usr/share/sounds/alsa/Rear_Left.wav"
        }
        
        sound_file = sound_files.get(level)
        if sound_file:
            try:
                subprocess.run([self._sound_cmd, sound_file], 
                             capture_output=True, timeout=3)
            except Exception:
                # „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: beep
                subprocess.run(["pactl", "upload-sample", "/usr/share/sounds/alsa/Front_Left.wav", "bell"], 
                             capture_output=True)
    
    def _play_macos_sound(self, level: NotificationLevel):
        """macOSÈü≥ÂÜçÁîü"""
        import subprocess
        
        sound_map = {
            NotificationLevel.INFO: "Glass",
            NotificationLevel.WARNING: "Sosumi",
            NotificationLevel.URGENT: "Basso"
        }
        
        sound_name = sound_map[level]
        subprocess.run(["afplay", f"/System/Library/Sounds/{sound_name}.aiff"],
                      capture_output=True, timeout=3)
    
    def _flash_screen(self):
        """ÁîªÈù¢„Çí„Éï„É©„ÉÉ„Ç∑„É•"""
        if not self.flash_available:
            return
        
        try:
            if self.platform == "Windows":
                self._flash_windows_screen()
            elif self.platform == "Linux":
                self._flash_linux_screen()
            elif self.platform == "Darwin":
                self._flash_macos_screen()
        except Exception as e:
            print(f"Screen flash error: {e}")
    
    def _flash_windows_screen(self):
        """WindowsÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•"""
        try:
            import ctypes
            from ctypes import wintypes
            
            # GetDC and FlashWindow APIs
            user32 = ctypes.windll.user32
            
            # „Éá„Çπ„ÇØ„Éà„ÉÉ„Éó„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇíÂèñÂæó„Åó„Å¶„Éï„É©„ÉÉ„Ç∑„É•
            hwnd = user32.GetDesktopWindow()
            
            for _ in range(self.config.flash_count):
                user32.FlashWindow(hwnd, True)
                time.sleep(self.config.flash_duration)
                
        except Exception as e:
            print(f"Windows flash error: {e}")
    
    def _flash_linux_screen(self):
        """LinuxÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•ÔºàX11Ôºâ"""
        try:
            import subprocess
            
            for _ in range(self.config.flash_count):
                # ÁîªÈù¢„ÅÆÊòéÂ∫¶„Çí‰∏ÄÊôÇÁöÑ„Å´Â§âÊõ¥
                subprocess.run(["xset", "dpms", "force", "off"], 
                             capture_output=True, timeout=1)
                time.sleep(self.config.flash_duration / 2)
                subprocess.run(["xset", "dpms", "force", "on"], 
                             capture_output=True, timeout=1)
                time.sleep(self.config.flash_duration / 2)
                
        except Exception as e:
            print(f"Linux flash error: {e}")
    
    def _flash_macos_screen(self):
        """macOSÁîªÈù¢„Éï„É©„ÉÉ„Ç∑„É•"""
        try:
            import subprocess
            
            for _ in range(self.config.flash_count):
                # AppleScript„Çí‰ΩøÁî®„Åó„Å¶„Éï„É©„ÉÉ„Ç∑„É•ÂäπÊûú
                script = '''
                tell application "System Events"
                    key down option
                    key up option
                end tell
                '''
                subprocess.run(["osascript", "-e", script], 
                             capture_output=True, timeout=2)
                time.sleep(self.config.flash_duration)
                
        except Exception as e:
            print(f"macOS flash error: {e}")
    
    def get_notification_history(self, limit: int = 10) -> list:
        """ÈÄöÁü•Â±•Ê≠¥„ÇíÂèñÂæó"""
        return self.notification_history[-limit:]
    
    def get_capabilities(self) -> Dict[str, bool]:
        """ÈÄöÁü•Ê©üËÉΩ„ÅÆÂØæÂøúÁä∂Ê≥Å„ÇíÂèñÂæó"""
        return {
            "toast": self.toast_available,
            "sound": self.sound_available,
            "flash": self.flash_available,
            "platform": self.platform
        }
    
    def test_notifications(self):
        """ÈÄöÁü•Ê©üËÉΩ„ÅÆ„ÉÜ„Çπ„Éà"""
        print(f"Testing notifications on {self.platform}...")
        
        capabilities = self.get_capabilities()
        print(f"Capabilities: {capabilities}")
        
        # ÂêÑ„É¨„Éô„É´„ÅÆÈÄöÁü•„Çí„ÉÜ„Çπ„Éà
        test_cases = [
            (NotificationLevel.INFO, "ÊÉÖÂ†±", "„Åì„Çå„ÅØÊÉÖÂ†±ÈÄöÁü•„ÅÆ„ÉÜ„Çπ„Éà„Åß„Åô"),
            (NotificationLevel.WARNING, "Ë≠¶Âëä", "„Åì„Çå„ÅØË≠¶ÂëäÈÄöÁü•„ÅÆ„ÉÜ„Çπ„Éà„Åß„Åô"),
            (NotificationLevel.URGENT, "Á∑äÊÄ•", "„Åì„Çå„ÅØÁ∑äÊÄ•ÈÄöÁü•„ÅÆ„ÉÜ„Çπ„Éà„Åß„Åô")
        ]
        
        for level, title, message in test_cases:
            print(f"Testing {level.value} notification...")
            success = self.notify(title, message, level)
            print(f"Result: {'Success' if success else 'Failed'}")
            time.sleep(2)  # ÈÄöÁü•Èñì„ÅÆÈñìÈöî


# ‰æøÂà©Èñ¢Êï∞„Å®„Ç∞„É≠„Éº„Éê„É´„Ç§„É≥„Çπ„Çø„É≥„Çπ
_default_service = None


def get_notification_service(config: Optional[NotificationConfig] = None) -> NotificationService:
    """„Éá„Éï„Ç©„É´„Éà„ÅÆÈÄöÁü•„Çµ„Éº„Éì„Çπ„ÇíÂèñÂæó"""
    global _default_service
    if _default_service is None:
        _default_service = NotificationService(config)
    return _default_service


def notify(title: str, 
           message: str, 
           level: NotificationLevel = NotificationLevel.INFO,
           **kwargs) -> bool:
    """‰æøÂà©Èñ¢Êï∞ÔºöÈÄöÁü•ÈÄÅ‰ø°"""
    service = get_notification_service()
    return service.notify(title, message, level, **kwargs)


def notify_gentle_nudge(message: str) -> bool:
    """‰æøÂà©Èñ¢Êï∞ÔºöËªΩ„ÅÑÊ≥®ÊÑèÂñöËµ∑"""
    return notify("Back2Task", message, NotificationLevel.WARNING)


def notify_strong_nudge(message: str) -> bool:
    """‰æøÂà©Èñ¢Êï∞ÔºöÂº∑„ÅÑÊ≥®ÊÑèÂñöËµ∑"""
    return notify("Back2Task - Focus!", message, NotificationLevel.URGENT, 
                  sound=True, flash=True)


def notify_task_complete(task_name: str) -> bool:
    """‰æøÂà©Èñ¢Êï∞Ôºö„Çø„Çπ„ÇØÂÆå‰∫ÜÈÄöÁü•"""
    return notify("„Çø„Çπ„ÇØÂÆå‰∫Ü", f"'{task_name}' „ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ", 
                  NotificationLevel.INFO, sound=True)


if __name__ == "__main__":
    # „ÉÜ„Çπ„ÉàÂÆüË°å
    service = NotificationService()
    service.test_notifications()